<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bosnian Survivors: REFORGED</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
    :root { --bosnia-blue:#002395; --bosnia-yellow:#fecb00; --neon-blue:#00f3ff; --rare-blue:#4facfe; --danger:#ff3f3f; --dark:#020205; }
    body { margin:0; overflow:hidden; background-color:var(--dark); font-family:'Rajdhani', sans-serif; color:white; user-select:none; cursor:crosshair; }
    
    /* UI LAYER */
    #ui-layer { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; z-index:50; }
    .hud-top { display:flex; justify-content:space-between; align-items:flex-start; pointer-events: none; }
    .stat-box { background:rgba(0,10,40,0.8); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); border-bottom:3px solid var(--bosnia-yellow); padding:10px 25px; border-radius:8px; display:flex; flex-direction:column; align-items:center; box-shadow:0 0 15px rgba(0,35,149,0.5); }
    .label { font-size:10px; color:#8899ac; text-transform:uppercase; letter-spacing:2px; font-family:'Orbitron'; margin-bottom:5px; }
    .value { font-size:28px; font-weight:700; color:#fff; text-shadow:0 0 10px rgba(255,255,255,0.5); }
    
    /* PAUSE BTN */
    #pause-btn { pointer-events: auto; background:rgba(0,10,40,0.8); border:1px solid var(--neon-blue); color:var(--neon-blue); width:40px; height:40px; border-radius:4px; font-family:'Orbitron'; font-weight:bold; cursor:pointer; margin-left:10px; display:flex; align-items:center; justify-content:center; transition:0.2s; }
    #pause-btn:hover { background:var(--neon-blue); color:black; box-shadow:0 0 15px var(--neon-blue); }

    .xp-container { position:fixed; top:0; left:0; width:100%; height:6px; background:#111; z-index:100; pointer-events: none; }
    #xp-fill { height:100%; width:0%; background:linear-gradient(90deg, #00c6ff, #0072ff); box-shadow:0 0 20px #00c6ff; transition:width 0.2s; }
    
    /* MENUS & MODALS */
    .screen-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(2, 2, 5, 0.95); backdrop-filter:blur(15px); z-index:2000; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; overflow-y:auto;}
    
    /* MAIN MENU */
    #main-menu { display:flex; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://img.freepik.com/free-vector/blue-futuristic-networking-technology-background-vector_53876-114068.jpg'); background-size:cover; }
    .menu-btn { background:linear-gradient(90deg, transparent, rgba(0, 35, 149, 0.6), transparent); border:1px solid var(--bosnia-blue); color:white; padding:15px 50px; margin:10px; font-size:24px; font-family:'Orbitron'; cursor:pointer; text-transform:uppercase; letter-spacing:4px; width:300px; transition:0.3s; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
    .menu-btn:hover { background:var(--bosnia-yellow); color:black; border-color:white; transform:scale(1.05); box-shadow:0 0 30px var(--bosnia-yellow); }

    /* INFO GRIDS */
    .info-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; max-width:1000px; width:90%; padding:20px; }
    .info-card { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:8px; display:flex; align-items:center; gap:15px; }
    .info-icon { font-size:40px; min-width:50px; text-align:center; }
    .info-text h3 { margin:0 0 5px 0; color:var(--bosnia-yellow); font-family:'Orbitron'; font-size:16px; }
    .info-text p { margin:0; color:#aaa; font-size:12px; line-height:1.4; }
    .close-btn { position:absolute; top:30px; right:30px; background:none; border:none; color:white; font-size:30px; cursor:pointer; }
    .close-btn:hover { color:var(--danger); }

    /* GAME OVER / LEVEL UP */
    .cards-container { display:flex; gap:20px; margin-top:30px; flex-wrap:wrap; justify-content:center; max-width:1000px; }
    .card { background:linear-gradient(160deg, #1a1a2e 0%, #16213e 100%); border:1px solid rgba(255,255,255,0.1); width:200px; height:320px; border-radius:12px; padding:20px; cursor:pointer; transition:0.3s; display:flex; flex-direction:column; align-items:center; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.6); position:relative; overflow:hidden; }
    .card::before { content:''; position:absolute; top:0; left:0; width:100%; height:5px; background:var(--bosnia-yellow); }
    .card:hover { transform:translateY(-10px) scale(1.05); box-shadow:0 0 30px rgba(254,203,0,0.2); border-color:var(--bosnia-yellow); }
    .card.legendary { border:2px solid var(--neon-blue); background:linear-gradient(160deg, #001f3f 0%, #000 100%); box-shadow:0 0 30px var(--neon-blue); }
    .card.legendary::before { background:var(--neon-blue); }
    .card-icon { font-size:50px; margin-bottom:20px; filter:drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
    .card-name { font-family:'Orbitron'; font-weight:700; color:#fff; margin-bottom:10px; font-size:16px; text-transform:uppercase; }
    .card-desc { font-size:13px; color:#aab; line-height:1.5; }
    .card-level { position:absolute; top:10px; right:10px; font-size:10px; color:#666; font-family:'Orbitron'; }

    .restart-btn { background:linear-gradient(45deg, var(--bosnia-yellow), #f39c12); color:black; border:none; padding:20px 60px; font-size:24px; font-weight:900; cursor:pointer; font-family:'Orbitron'; clip-path:polygon(15% 0, 100% 0, 100% 70%, 85% 100%, 0 100%, 0 30%); transition:0.2s; box-shadow:0 0 30px var(--bosnia-yellow); margin-top:30px; text-transform:uppercase; }
    .restart-btn:hover { transform:scale(1.1); box-shadow:0 0 60px var(--bosnia-yellow); color:white; }
    
    canvas { display:block; position:absolute; top:0; left:0; z-index:1; }
</style>
</head>
<body>

<div class="xp-container"><div id="xp-fill"></div></div>

<!-- MAIN MENU -->
<div id="main-menu" class="screen-overlay" style="display:flex;">
    <h1 style="font-family:'Orbitron'; font-size:60px; color:white; text-shadow:0 0 30px var(--bosnia-blue); text-align:center;">BOSNIAN<br><span style="color:var(--bosnia-yellow)">SURVIVORS</span></h1>
    <div style="height:40px;"></div>
    <button class="menu-btn" onclick="startGame()">DEPLOY</button>
    <button class="menu-btn" onclick="openInfo('armory')">ARMORY</button>
    <button class="menu-btn" onclick="openInfo('intel')">INTEL</button>
</div>

<!-- INFO MODAL -->
<div id="info-modal" class="screen-overlay">
    <button class="close-btn" onclick="closeInfo()">Ã—</button>
    <h1 id="info-title" style="font-family:'Orbitron'; color:var(--bosnia-yellow); margin-top:50px;">DATA</h1>
    <div id="info-content" class="info-grid"></div>
</div>

<!-- PAUSE MENU -->
<div id="pause-screen" class="screen-overlay">
    <h1 style="font-family:'Orbitron'; font-size:50px; color:var(--neon-blue);">PAUSED</h1>
    <button class="menu-btn" onclick="togglePause()">RESUME</button>
    <button class="menu-btn" onclick="quitGame()">MAIN MENU</button>
</div>

<!-- GAME UI -->
<div id="ui-layer" style="display:none;">
    <div class="hud-top">
        <div class="stat-box"><div class="label">Threat Level</div><div class="value" style="color:var(--bosnia-yellow)" id="lvl-display">1</div></div>
        <div style="width:400px; text-align:center;">
             <div style="width:100%; height:8px; background:rgba(0,0,0,0.5); margin-top:10px; border-radius:4px; overflow:hidden; border:1px solid #333;"><div id="hp-fill" style="width:100%; height:100%; background:linear-gradient(90deg, #ff3f3f, #ff0000); box-shadow:0 0 15px red;"></div></div>
        </div>
        <div style="display:flex;">
            <div class="stat-box"><div class="label">Confirmed Kills</div><div class="value" style="color:#fff" id="score-display">0</div></div>
            <button id="pause-btn" onclick="togglePause()">||</button>
        </div>
    </div>
</div>

<div id="levelup-screen" class="screen-overlay">
    <h1 style="font-family:'Orbitron'; font-size:40px; color:var(--bosnia-yellow); margin-bottom:10px; text-shadow:0 0 20px var(--bosnia-yellow);">SYSTEM UPGRADE</h1>
    <p style="color:#ccc; margin-bottom:30px; font-size:18px;">Select an augmentation</p>
    <div class="cards-container" id="cards-box"></div>
</div>

<div id="game-over" class="screen-overlay">
    <h1 style="color:#ff3f3f; font-family:'Orbitron'; font-size:90px; margin:0; text-shadow:0 0 50px red; letter-spacing:5px;">MIA</h1>
    <p style="font-size:24px; color:white;">FINAL SCORE: <span id="final-score" style="color:var(--bosnia-yellow); font-weight:bold;">0</span></p>
    <button class="restart-btn" onclick="resetGame()">RESPAWN</button>
    <button class="menu-btn" style="margin-top:20px; font-size:16px;" onclick="quitGame()">EXIT TO MENU</button>
</div>

<canvas id="game"></canvas>

<script>
    const canvas = document.getElementById('game'), ctx = canvas.getContext('2d', { alpha: false });
    let W, H;
    
    // DEFINITIONS
    const UPGRADES=[
        {id:'burek',name:'Golden Burek',icon:'ðŸ¥',desc:'Adds a rotating shield that damages enemies.'},
        {id:'cevapi',name:'Rapid Cevapi',icon:'ðŸŒ­',desc:'Fires delicious meat missiles at nearest targets.'},
        {id:'ajvar',name:'Nuclear Ajvar',icon:'ðŸŒ¶ï¸',desc:'Throws explosive jars dealing AoE damage.'},
        {id:'rakija',name:'Holy Rakija',icon:'ðŸ¾',desc:'Creates purifying fire zones on the ground.'},
        {id:'pyramid',name:'Visoko Beam',icon:'â›°ï¸',desc:'Fires a high-energy piercing triangle beam.'},
        {id:'harmonika',name:'Harmonika',icon:'ðŸŽ¹',desc:'Emits a sonic shockwave that pushes enemies back.'},
        {id:'speed',name:'Turbo Folk Speed',icon:'âš¡',desc:'Increases Movement Speed by 20%.'},
        {id:'magnet',name:'Super Magnet',icon:'ðŸ§²',desc:'Increases Item Pickup Range by 50%.'},
        {id:'armor',name:'Kevlar Vest',icon:'ðŸ›¡ï¸',desc:'Reduces incoming damage.'},
        {id:'heal',name:'Grandma Soup',icon:'ðŸ²',desc:'Instantly restores 50 HP.'},
        {id:'coffee',name:'Bosnian Coffee',icon:'â˜•',desc:'Reduces all weapon cooldowns by 10%.'},
        {id:'lily',name:'Golden Lily',icon:'âšœï¸',desc:'Increases Critical Hit Chance by 10%.'},
        {id:'vrelo',name:'Vrelo Bosne',icon:'ðŸžï¸',desc:'Regenerates 2 HP per second.'},
        {id:'xp_boost',name:'Big Brain',icon:'ðŸ§ ',desc:'2x EXP Gain for rest of run!', rare:true}
    ];

    const ENEMY_INFO = [
        {name:'Promaja', icon:'ðŸ’¨', desc:'The silent killer. Weak but fast.'},
        {name:'Yugo 45', icon:'ðŸš—', desc:'Tanky unit. Hard to destroy, hits like a truck.'},
        {name:'Hornet', icon:'ðŸ', desc:'Swarm unit. Attacks in groups.'}
    ];

    // GAME VARIABLES
    let gameActive = false;
    let isPaused = false;
    
    let state = { frames:0, score:0, level:1, xp:0, nextLevelXp:20, xpMult:1, shake:0, enemies:[], particles:[], projectiles:[], zones:[], texts:[], gems:[], perks:[], mouse:{x:0,y:0} };
    let player = { x:0, y:0, hp:100, maxHp:100, speed:6, radius:20, magnetRadius:120, armor:0, regen:0, critChance:0.05, cdr:1.0, facing:0, weapons:{} };

    function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    const keys = {};
    window.addEventListener('keydown', e=>{
        keys[e.key.toLowerCase()]=true;
        if(e.key === "Escape" && gameActive) togglePause();
    }); 
    window.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);
    window.addEventListener('mousemove', e=>{ state.mouse.x=e.clientX; state.mouse.y=e.clientY; });

    // --- MENU SYSTEM ---

    function openInfo(type){
        document.getElementById('info-modal').style.display='flex';
        const content = document.getElementById('info-content');
        const title = document.getElementById('info-title');
        content.innerHTML = '';
        
        if(type === 'armory'){
            title.innerText = "ARMORY PROTOCOLS";
            UPGRADES.forEach(u => {
                content.innerHTML += `
                <div class="info-card">
                    <div class="info-icon">${u.icon}</div>
                    <div class="info-text"><h3>${u.name}</h3><p>${u.desc}</p></div>
                </div>`;
            });
        } else {
            title.innerText = "THREAT INTEL";
            ENEMY_INFO.forEach(e => {
                content.innerHTML += `
                <div class="info-card">
                    <div class="info-icon">${e.icon}</div>
                    <div class="info-text"><h3>${e.name}</h3><p>${e.desc}</p></div>
                </div>`;
            });
        }
    }

    function closeInfo(){ document.getElementById('info-modal').style.display='none'; }
    
    function startGame(){
        document.getElementById('main-menu').style.display='none';
        resetGame();
    }
    
    function quitGame(){
        gameActive = false;
        document.getElementById('game-over').style.display='none';
        document.getElementById('pause-screen').style.display='none';
        document.getElementById('ui-layer').style.display='none';
        document.getElementById('main-menu').style.display='flex';
    }

    function togglePause(){
        if(!gameActive) return;
        // Don't allow pausing if leveled up
        if(document.getElementById('levelup-screen').style.display === 'flex') return;
        
        isPaused = !isPaused;
        document.getElementById('pause-screen').style.display = isPaused ? 'flex' : 'none';
    }

    function resetGame(){
        // Reset Logic
        gameActive = true;
        isPaused = false;
        state = { 
            frames:0, score:0, level:1, xp:0, nextLevelXp:20, xpMult:1, shake:0, 
            enemies:[], particles:[], projectiles:[], zones:[], texts:[], gems:[], perks:[], 
            mouse:{x:W/2,y:H/2} 
        };
        
        player = { 
            x:W/2, y:H/2, hp:100, maxHp:100, speed:6, radius:20, magnetRadius:120, armor:0, regen:0, critChance:0.05, cdr:1.0, facing:0, 
            weapons:{
                burek: { level:1, count:1, damage:10, dist:100, speed:0.04, evolved:false, orbs:[] },
                cevapi: { level:1, cooldown:30, baseCool:30, timer:0, damage:15 }, 
                ajvar: { level:0, cooldown:140, baseCool:140, timer:0, damage:80 },
                rakija: { level:0, cooldown:190, baseCool:190, timer:0, damage:4, duration:300 }, 
                pyramid: { level:0, cooldown:110, baseCool:110, timer:0, damage:50 },
                harmonika: { level:0, cooldown:600, baseCool:600, timer:0, damage:60, range:250 } 
            }
        };

        document.getElementById('game-over').style.display='none';
        document.getElementById('levelup-screen').style.display='none';
        document.getElementById('pause-screen').style.display='none';
        document.getElementById('ui-layer').style.display='flex';
        updateHud();
    }

    // --- GAME ENGINE ---

    function createParticle(x,y,color,type,speedM=1) {
        if(state.particles.length>400) return;
        const p={x:x,y:y,vx:(Math.random()-0.5)*8*speedM,vy:(Math.random()-0.5)*8*speedM,life:1,decay:0.01+Math.random()*0.03,color:color,size:Math.random()*6+2,type:type};
        if(type==='fire'){p.vy-=2;p.decay=0.04;} if(type==='spark'){p.decay=0.05;p.size=2;} if(type==='smoke'){p.vx*=0.3;p.vy*=0.3;p.size=10;p.decay=0.01;} if(type==='plasma'){p.decay=0.08;p.size=Math.random()*10;}
        if(type==='note'){p.decay=0.02;p.size=8;p.vx*=0.5;p.vy=-2;}
        state.particles.push(p);
    }
    
    function spawnDamageText(x,y,dmg,isCrit){ 
        let v = (typeof dmg === 'string') ? dmg : Math.floor(dmg);
        state.texts.push({x:x+(Math.random()-0.5)*20,y:y,val:v,life:1,color:isCrit?'#00f3ff':'#fff',scale:isCrit?1.5:1}); 
    }
    
    function addShake(amt){ state.shake=Math.min(state.shake+amt,25); }
    
    function calcDamage(base){ 
        let levelBonus = Math.max(0, state.level - 1); 
        let totalBase = base + levelBonus;
        let isCrit = Math.random() < player.critChance; 
        let dmg = totalBase * (isCrit ? 2.0 : 1.0); 
        return {d:dmg, c:isCrit}; 
    }

    class Perk {
        constructor(x,y,type){
            this.x=x; this.y=y; this.type=type; this.bob=0;
            if(type==='health') this.icon='â¤ï¸';
            else if(type==='magnet') this.icon='ðŸ§²';
            else if(type==='nuke') this.icon='â˜¢ï¸';
            else if(type==='freeze') this.icon='â„ï¸';
        }
        update(){
            this.bob+=0.1; 
            const dx=player.x-this.x, dy=player.y-this.y, dist=Math.sqrt(dx*dx+dy*dy);
            if(dist < player.radius + 30){
                if(this.type==='health'){ player.hp = Math.min(player.maxHp, player.hp+50); spawnDamageText(player.x,player.y-50,"HEALED",true); for(let i=0;i<10;i++)createParticle(this.x,this.y,'#f00','spark');}
                if(this.type==='magnet'){ state.gems.forEach(g=>g.vacuum=true); spawnDamageText(player.x,player.y-50,"MAGNETIC",true);}
                if(this.type==='nuke'){ addShake(30); state.enemies.forEach(e=>{ if(!e.dead){ e.takeDamage(9999, true); } }); spawnDamageText(player.x,player.y-50,"NUKE",true); for(let i=0;i<50;i++)createParticle(player.x,player.y,'#ffaa00','fire',5); }
                if(this.type==='freeze'){ state.enemies.forEach(e=>{ e.frozen=300; }); spawnDamageText(player.x,player.y-50,"FROZEN",true); for(let i=0;i<20;i++)createParticle(player.x,player.y,'#00ffff','spark',2); }
                updateHud();
                return true; 
            }
            return false;
        }
        draw(cX,cY){
            ctx.font="30px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.shadowBlur=20; ctx.shadowColor='#fff';
            ctx.fillText(this.icon, this.x-cX, this.y-cY + Math.sin(this.bob)*5); ctx.shadowBlur=0;
        }
    }

    class Gem {
        constructor(x,y){this.x=x;this.y=y;this.value=5+(state.level*0.8);this.wobble=Math.random()*6.28;this.vacuum=false;}
        update(){
            this.wobble+=0.1; const dx=player.x-this.x, dy=player.y-this.y, dist=Math.sqrt(dx*dx+dy*dy);
            if(this.vacuum || dist<player.magnetRadius){
                let speed = this.vacuum ? 25 : 16;
                this.x+=(dx/dist)*speed;this.y+=(dy/dist)*speed;
            }
            if(dist<player.radius+20){state.xp+=this.value * state.xpMult; checkLevelUp();updateHud();return true;} return false;
        }
        draw(cX,cY){
            ctx.fillStyle='#fecb00'; ctx.shadowBlur=10; ctx.shadowColor='#fecb00'; ctx.beginPath();
            ctx.moveTo(this.x-cX,(this.y-cY)-6+Math.sin(this.wobble)*2); ctx.lineTo((this.x-cX)+6,this.y-cY+Math.sin(this.wobble)*2);
            ctx.lineTo(this.x-cX,(this.y-cY)+6+Math.sin(this.wobble)*2); ctx.lineTo((this.x-cX)-6,this.y-cY+Math.sin(this.wobble)*2); ctx.fill(); ctx.shadowBlur=0;
        }
    }
    class Projectile {
        constructor(x,y,target,type){
            this.x=x;this.y=y;this.type=type;this.life=150;this.rotation=0; let a=target?Math.atan2(target.y-y,target.x-x):Math.random()*6.28;
            if(type==='cevapi'){this.speed=14;this.radius=6;} else if(type==='ajvar'){this.speed=8;this.radius=10;}
            else if(type==='rakija'){this.speed=10;this.radius=8;} else if(type==='pyramid'){this.speed=7;this.radius=25;this.life=300;this.pierce=true;}
            this.vx=Math.cos(a)*this.speed; this.vy=Math.sin(a)*this.speed;
        }
        update(){
            this.x+=this.vx;this.y+=this.vy;this.life--;this.rotation+=0.15;
            if(state.frames%2===0){ if(this.type==='pyramid')createParticle(this.x,this.y,'#2ecc71','spark',0.1); if(this.type==='cevapi')createParticle(this.x,this.y,'#8b4513','smoke',0.2); }
            if(this.type==='ajvar'||this.type==='rakija'){ this.vx*=0.96;this.vy*=0.96;this.rotation=this.vx*0.2; if(this.life<100 && Math.abs(this.vx)<1)this.explode(); }
        }
        explode(){
            this.life=0; 
            if(this.type==='ajvar'){ addShake(15); let dmg=calcDamage(player.weapons.ajvar.damage); state.enemies.forEach(e=>{if(Math.hypot(e.x-this.x,e.y-this.y)<150)e.takeDamage(dmg.d, dmg.c)}); for(let i=0;i<30;i++)createParticle(this.x,this.y,'#ff4500','fire',2); }
            if(this.type==='rakija'){ state.zones.push(new Zone(this.x,this.y,'fire',player.weapons.rakija.duration)); for(let i=0;i<20;i++)createParticle(this.x,this.y,'#00ffff','fire',1.5); }
        }
        draw(cX,cY){
            ctx.save(); ctx.translate(this.x-cX,this.y-cY); ctx.rotate(this.rotation);
            if(this.type==='cevapi'){ ctx.fillStyle='#a0522d';ctx.shadowColor='#d35400';ctx.shadowBlur=10;ctx.beginPath();ctx.roundRect(-8,-3,16,6,3);ctx.fill();ctx.fillStyle='#3e2723';ctx.fillRect(-4,-3,2,6);ctx.fillRect(2,-3,2,6);}
            else if(this.type==='ajvar'){ ctx.fillStyle='#c0392b';ctx.beginPath();ctx.arc(0,0,9,0,6.28);ctx.fill();ctx.fillStyle='#f1c40f';ctx.beginPath();ctx.arc(0,-5,5,0,6.28);ctx.fill();}
            else if(this.type==='rakija'){ ctx.fillStyle='#aaddff';ctx.globalAlpha=0.6;ctx.beginPath();ctx.rect(-5,-8,10,16);ctx.fill();ctx.globalAlpha=1;ctx.fillStyle='#00f';ctx.fillRect(-3,-10,6,2);}
            else if(this.type==='pyramid'){ ctx.fillStyle='#00ff00';ctx.shadowBlur=15;ctx.shadowColor='#00ff00';ctx.beginPath();ctx.moveTo(0,-25);ctx.lineTo(20,20);ctx.lineTo(-20,20);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,5,8,0,6.28);ctx.fill();ctx.restore();}
            ctx.restore();
        }
    }
    class Zone {
        constructor(x,y,type,dur){this.x=x;this.y=y;this.life=dur;this.radius=90;if(type==='harmonika')this.radius=150;}
        update(){ 
            this.life--; 
            if(this.type==='harmonika') { this.radius+=5; if(this.life%5===0)createParticle(this.x+(Math.random()-0.5)*100, this.y+(Math.random()-0.5)*100, '#fff', 'note'); }
            else if(state.frames%10===0) state.enemies.forEach(e=>{if(Math.hypot(e.x-this.x,e.y-this.y)<this.radius){
                let dmg = calcDamage(player.weapons.rakija.damage);
                e.takeDamage(dmg.d, false);
                createParticle(e.x,e.y,'#00ffff','fire',0.5);
            }}); 
            return this.life<=0;
        }
        draw(cX,cY){ ctx.save();ctx.translate(this.x-cX,this.y-cY); let p=1+Math.sin(state.frames*0.1)*0.1; ctx.scale(p,p); let g=ctx.createRadialGradient(0,0,10,0,0,this.radius);g.addColorStop(0,'rgba(0,255,255,0.6)');g.addColorStop(1,'rgba(0,50,255,0)');ctx.globalCompositeOperation='lighter';ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.radius,0,6.28);ctx.fill();ctx.restore();}
    }
    class Enemy {
        constructor(){
            let a=Math.random()*6.28, d=(Math.max(W,H)/2)+200; this.x=player.x+Math.cos(a)*d; this.y=player.y+Math.sin(a)*d;
            let r=Math.random(); if(r<0.15 && state.level>2)this.type='yugo'; else if(r<0.45 && state.level>1)this.type='hornet'; else this.type='promaja';
            if(this.type==='promaja'){this.hp=40+state.level*6;this.speed=2+Math.random();this.radius=22;} else if(this.type==='yugo'){this.hp=200+state.level*20;this.speed=1.5;this.radius=35;this.angle=0;} else{this.hp=25+state.level*3;this.speed=4.5;this.radius=15;}
            this.maxHp=this.hp; this.hitFlash=0; this.pushX=0; this.pushY=0; this.frozen=0;
        }
        update(){
            if(this.frozen > 0) { 
                this.frozen--; 
                if(state.frames%20===0) createParticle(this.x,this.y,'#0ff','spark');
                return;
            }
            let dx=player.x-this.x, dy=player.y-this.y, dist=Math.sqrt(dx*dx+dy*dy); this.angle=Math.atan2(dy,dx);
            let px=0,py=0; state.enemies.forEach(o=>{if(o!==this){let ox=this.x-o.x,oy=this.y-o.y,od=Math.sqrt(ox*ox+oy*oy);if(od<this.radius+o.radius){px+=ox/od;py+=oy/od;}}});
            this.x+=(Math.cos(this.angle)*this.speed+px*0.5)+this.pushX; this.y+=(Math.sin(this.angle)*this.speed+py*0.5)+this.pushY; 
            this.pushX*=0.9; this.pushY*=0.9; if(this.hitFlash>0)this.hitFlash--;
            if(this.type==='yugo'&&state.frames%10===0)createParticle(this.x-Math.cos(this.angle)*30,this.y-Math.sin(this.angle)*30,'#555','smoke');
        }
        takeDamage(a, crit){
            this.hp-=a; this.hitFlash=5; spawnDamageText(this.x,this.y-30,a,crit); let c=(this.type==='yugo')?'#000':(this.type==='hornet'?'#bfff00':'#880000'); for(let i=0;i<3;i++)createParticle(this.x,this.y,c,'spark');
            if(this.hp<=0){ this.dead=true; state.score++; state.gems.push(new Gem(this.x,this.y)); for(let i=0;i<8;i++)createParticle(this.x,this.y,c,'blood',1.5); if(this.type==='yugo'){addShake(5);for(let i=0;i<15;i++)createParticle(this.x,this.y,'#f39c12','fire',2);} }
        }
        draw(cX,cY){
            ctx.save(); ctx.translate(this.x-cX,this.y-cY);
            if(this.frozen>0) { ctx.shadowBlur=10; ctx.shadowColor='#00ffff'; }
            if(this.hitFlash>0){ ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,this.radius,0,6.28);ctx.fill();} else {
                if(this.type==='promaja'){ ctx.globalAlpha=0.6;ctx.shadowBlur=20;ctx.shadowColor='#fff';ctx.fillStyle='#eef';ctx.rotate(state.frames*0.05);ctx.beginPath();for(let i=0;i<3;i++)ctx.ellipse(0,0,10,25,(6.28/3)*i,0,6.28);ctx.fill();ctx.rotate(-state.frames*0.05);ctx.globalAlpha=1;ctx.fillStyle='#f00';ctx.beginPath();ctx.arc(-8,-5,3,0,6.28);ctx.arc(8,-5,3,0,6.28);ctx.fill();}
                else if(this.type==='yugo'){ ctx.rotate(this.angle);ctx.globalCompositeOperation='lighter';ctx.fillStyle='rgba(255,255,200,0.4)';ctx.beginPath();ctx.moveTo(20,-10);ctx.lineTo(150,-40);ctx.lineTo(150,40);ctx.lineTo(20,10);ctx.fill();ctx.globalCompositeOperation='source-over';ctx.fillStyle='#8b0000';ctx.fillRect(-35,-20,70,40);ctx.fillStyle='#600000';ctx.fillRect(-15,-18,40,36);ctx.fillStyle='#87ceeb';ctx.fillRect(15,-16,10,32);ctx.fillStyle='#ffff00';ctx.fillRect(30,-18,5,10);ctx.fillRect(30,8,5,10);}
                else{ ctx.rotate(this.angle+1.57);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.ellipse(10,-5,8,20,0.5,0,6.28);ctx.fill();ctx.beginPath();ctx.ellipse(-10,-5,8,20,-0.5,0,6.28);ctx.fill();ctx.fillStyle='#111';ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(12,12);ctx.lineTo(-12,12);ctx.fill();ctx.fillStyle='#ff0';ctx.fillRect(-8,-5,16,4);ctx.fillRect(-6,2,12,4);ctx.fillStyle='#f00';ctx.beginPath();ctx.moveTo(0,12);ctx.lineTo(3,20);ctx.lineTo(-3,20);ctx.fill();}
            } 
            if(this.frozen>0){ ctx.fillStyle='rgba(0,255,255,0.4)';ctx.beginPath();ctx.arc(0,0,this.radius+5,0,6.28);ctx.fill();}
            ctx.restore();
        }
    }

    function checkLevelUp(){ 
        if(state.xp>=state.nextLevelXp){
            state.xp-=state.nextLevelXp;
            state.level++;
            player.maxHp += 10; player.hp += 10;
            spawnDamageText(player.x, player.y-60, "+10 HP", true);
            state.nextLevelXp=Math.floor(state.nextLevelXp*1.5);
            isPaused = true;
            generateCards();
        } 
    }
    
    function updateHud(){ document.getElementById('lvl-display').innerText=state.level; document.getElementById('score-display').innerText=state.score; document.getElementById('xp-fill').style.width=Math.min(100,(state.xp/state.nextLevelXp*100))+'%'; document.getElementById('hp-fill').style.width=Math.max(0,(player.hp/player.maxHp*100))+'%'; }
    
    function gameLoop(){ 
        if(gameActive && !isPaused){ update(); draw(); } 
        else if(!gameActive) {
            // Draw simple background for menu
            ctx.fillStyle='#020205'; ctx.fillRect(0,0,W,H);
        }
        requestAnimationFrame(gameLoop); 
    }
    
    function getClosestEnemy(){ let c=null,m=800; state.enemies.forEach(e=>{let d=Math.hypot(e.x-player.x,e.y-player.y);if(d<m){m=d;c=e;}}); return c; }

    function spawnPerk() {
        let attempts = 0;
        let valid = false;
        let px, py;
        while(!valid && attempts < 15) {
            const dist = 300 + Math.random() * 400; 
            const angle = Math.random() * 6.28;
            px = player.x + Math.cos(angle) * dist; 
            py = player.y + Math.sin(angle) * dist;
            let safe = true;
            for(let e of state.enemies) {
                if(Math.hypot(e.x - px, e.y - py) < e.radius + 40) { safe = false; break; }
            }
            if(safe) valid = true;
            attempts++;
        }
        if(valid) {
            const types = ['health', 'magnet', 'nuke', 'freeze'];
            state.perks.push(new Perk(px, py, types[Math.floor(Math.random() * types.length)]));
        }
    }

    function update(){
        let mx=0,my=0; if(keys['w']||keys['arrowup'])my=-1; if(keys['s']||keys['arrowdown'])my=1; if(keys['a']||keys['arrowleft'])mx=-1; if(keys['d']||keys['arrowright'])mx=1;
        if(mx!==0||my!==0){ let l=Math.sqrt(mx*mx+my*my); player.x+=(mx/l)*player.speed; player.y+=(my/l)*player.speed; player.facing=Math.atan2(my,mx); }
        else player.facing=Math.atan2(state.mouse.y-H/2,state.mouse.x-W/2);

        if(player.regen>0 && state.frames%60===0 && player.hp<player.maxHp){ player.hp=Math.min(player.maxHp, player.hp+player.regen); updateHud(); spawnDamageText(player.x,player.y-50,player.regen,true); }

        if(state.frames%Math.max(5,50-state.level*2)===0){ for(let i=0;i<1+Math.floor(state.level/5);i++)state.enemies.push(new Enemy()); }
        if(Math.random() < 0.0008) spawnPerk();

        const wc=player.weapons.cevapi; if(wc.level>0){ wc.timer++; if(wc.timer>wc.cooldown){let t=getClosestEnemy();if(t){state.projectiles.push(new Projectile(player.x,player.y,t,'cevapi'));wc.timer=0;}} }
        const wa=player.weapons.ajvar; if(wa.level>0){ wa.timer++; if(wa.timer>wa.cooldown&&state.enemies.length>0){let ts=state.enemies.filter(e=>Math.hypot(e.x-player.x,e.y-player.y)<700);if(ts.length){state.projectiles.push(new Projectile(player.x,player.y,ts[Math.floor(Math.random()*ts.length)],'ajvar'));wa.timer=0;}} }
        const wr=player.weapons.rakija; if(wr.level>0){ wr.timer++; if(wr.timer>wr.cooldown){let t=getClosestEnemy();if(t){state.projectiles.push(new Projectile(player.x,player.y,t,'rakija'));wr.timer=0;}} }
        const wp=player.weapons.pyramid; if(wp.level>0){ wp.timer++; if(wp.timer>wp.cooldown){let t=getClosestEnemy();state.projectiles.push(new Projectile(player.x,player.y,t,'pyramid'));wp.timer=0;} }
        const wh=player.weapons.harmonika; if(wh.level>0){ wh.timer++; if(wh.timer>wh.cooldown){
            addShake(15); state.zones.push(new Zone(player.x,player.y,'harmonika',20));
            state.enemies.forEach(e=>{ 
                let dist=Math.hypot(e.x-player.x,e.y-player.y); 
                if(dist<wh.range){ let pushA=Math.atan2(e.y-player.y,e.x-player.x); e.pushX=Math.cos(pushA)*45; e.pushY=Math.sin(pushA)*45; let dmg = calcDamage(wh.damage); e.takeDamage(dmg.d, dmg.c); } 
            });
            wh.timer=0;
        }}

        state.gems=state.gems.filter(g=>!g.update()); state.zones=state.zones.filter(z=>!z.update()); state.perks=state.perks.filter(p=>!p.update());
        state.projectiles.forEach(p=>p.update()); state.projectiles=state.projectiles.filter(p=>{if(p.type==='pyramid'&&p.life>0){state.enemies.forEach(e=>{if(Math.hypot(e.x-p.x,e.y-p.y)<e.radius+25){let dmg=calcDamage(player.weapons.pyramid.damage); e.takeDamage(dmg.d, dmg.c);createParticle(e.x,e.y,'#0f0','spark');}});return true;} return p.life>0;});

        state.enemies.forEach(e=>{
            e.update();
            if(!e.frozen && Math.hypot(e.x-player.x,e.y-player.y)<player.radius+e.radius-5){ player.hp-=Math.max(0.1,((e.type==='yugo'?1:0.4)-(player.armor*0.05))); addShake(2); updateHud(); if(player.hp<=0){document.getElementById('final-score').innerText=state.score;document.getElementById('game-over').style.display='flex';gameActive=false;} }
            
            const bur=player.weapons.burek; while(bur.orbs.length<bur.count)bur.orbs.push({timer:0});
            for(let b=0;b<bur.count;b++){
                if(bur.orbs[b].timer>0){ bur.orbs[b].timer--; continue; }
                const ang=(state.frames*bur.speed)+(b*6.28/bur.count), bx=player.x+Math.cos(ang)*bur.dist, by=player.y+Math.sin(ang)*bur.dist;
                if(Math.hypot(e.x-bx,e.y-by)<(bur.evolved?60:45)){
                    if(bur.evolved){ let mainDmg = calcDamage(100); let splashDmg = calcDamage(50); e.takeDamage(mainDmg.d, true); createParticle(bx,by,'#00f3ff','plasma',2); addShake(10); state.enemies.forEach(s=>{if(Math.hypot(s.x-bx,s.y-by)<150)s.takeDamage(splashDmg.d, false)}); bur.orbs[b].timer=300; }
                    else if(state.frames%6===0){ let dmg=calcDamage(bur.damage); e.takeDamage(dmg.d, dmg.c); createParticle(e.x,e.y,'#e67e22','spark'); }
                }
            }
            state.projectiles.forEach(p=>{if(p.type==='cevapi'&&Math.hypot(e.x-p.x,e.y-p.y)<e.radius+15){let dmg=calcDamage(player.weapons.cevapi.damage); e.takeDamage(dmg.d, dmg.c);p.life=0;}});
        });
        state.enemies=state.enemies.filter(e=>!e.dead && Math.hypot(e.x-player.x,e.y-player.y)<2000);
        state.particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;p.vx*=0.95;p.vy*=0.95;}); state.particles=state.particles.filter(p=>p.life>0);
        state.texts.forEach(t=>{t.y-=1;t.life-=0.02;}); state.texts=state.texts.filter(t=>t.life>0);
        if(state.shake>0)state.shake*=0.9; state.frames++;
    }

    function draw(){
        let cX=player.x-W/2, cY=player.y-H/2; if(state.shake>0.5){cX+=(Math.random()-0.5)*state.shake;cY+=(Math.random()-0.5)*state.shake;}
        ctx.fillStyle='#020205'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath();
        let ox=-cX%150, oy=-cY%150; for(let i=ox;i<W;i+=150){ctx.moveTo(i,0);ctx.lineTo(i,H);} for(let i=oy;i<H;i+=150){ctx.moveTo(0,i);ctx.lineTo(W,i);} ctx.stroke();
        state.zones.forEach(z=>z.draw(cX,cY)); state.gems.forEach(g=>g.draw(cX,cY)); state.perks.forEach(p=>p.draw(cX,cY)); state.enemies.forEach(e=>e.draw(cX,cY)); state.projectiles.forEach(p=>p.draw(cX,cY));
        
        let pX=player.x-cX, pY=player.y-cY; ctx.save(); ctx.translate(pX,pY); ctx.rotate(player.facing+1.57);
        ctx.shadowBlur=20; ctx.shadowColor='rgba(254,203,0,0.5)'; ctx.fillStyle='#c0392b'; ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(10,0); ctx.lineTo(15+Math.sin(state.frames*0.5)*5,35); ctx.lineTo(-15+Math.sin(state.frames*0.5)*5,35); ctx.fill();
        ctx.fillStyle='#fecb00';ctx.beginPath();ctx.ellipse(0,0,15,10,0,0,6.28);ctx.fill();ctx.fillStyle='#d4af37';ctx.beginPath();ctx.arc(0,0,10,0,6.28);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-4,-2,8,3);
        ctx.fillStyle='#eee';ctx.fillRect(10,-10,4,30);ctx.fillStyle='#fecb00';ctx.fillRect(8,0,8,4); ctx.restore();

        const bur=player.weapons.burek;
        for(let i=0;i<bur.count;i++){
            if(!bur.orbs[i] || bur.orbs[i].timer>0) continue;
            let ang=(state.frames*bur.speed)+(i*6.28/bur.count), bx=pX+Math.cos(ang)*bur.dist, by=pY+Math.sin(ang)*bur.dist;
            ctx.save(); ctx.translate(bx,by);
            if(bur.evolved){ ctx.shadowBlur=25;ctx.shadowColor='#00f3ff';ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,12,0,6.28);ctx.fill(); ctx.strokeStyle='#00f3ff';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,18,0,6.28);ctx.stroke(); } 
            else { ctx.rotate(ang*3);ctx.shadowBlur=15;ctx.shadowColor='#d35400';ctx.fillStyle='#e67e22';ctx.beginPath();ctx.arc(0,0,15,0,6.28);ctx.fill(); ctx.strokeStyle='#d35400';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,10,0,4.7);ctx.stroke();ctx.beginPath();ctx.arc(0,0,5,0.5,5.6);ctx.stroke(); } ctx.restore();
        }

        ctx.globalCompositeOperation='lighter'; state.particles.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x-cX,p.y-cY,p.size,0,6.28);ctx.fill();});
        if(state.frames%20===0 && player.weapons.harmonika.level>0){ ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.beginPath();ctx.arc(pX,pY,player.weapons.harmonika.range,0,6.28);ctx.stroke(); }
        ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1; ctx.shadowBlur=0;
        let lg=ctx.createRadialGradient(W/2,H/2,100,W/2,H/2,Math.max(W,H));lg.addColorStop(0,'rgba(0,0,0,0)');lg.addColorStop(0.5,'rgba(0,2,10,0.4)');lg.addColorStop(1,'rgba(0,0,0,0.85)');ctx.fillStyle=lg;ctx.fillRect(0,0,W,H);
        state.texts.forEach(t=>{ctx.fillStyle=t.color;ctx.font=`bold ${20*t.scale}px Orbitron`;ctx.strokeStyle='black';ctx.lineWidth=2;ctx.strokeText(t.val,t.x-cX,t.y-cY);ctx.fillText(t.val,t.x-cX,t.y-cY);});
    }

    function generateCards(){
        const c=document.getElementById('cards-box'); c.innerHTML=''; document.getElementById('levelup-screen').style.display='flex';
        let pool=UPGRADES.slice(); 
        if(state.xpMult > 1) pool = pool.filter(u => u.id !== 'xp_boost');
        if(player.weapons.burek.evolved || player.weapons.burek.level >= 8) { pool = pool.filter(u => u.id !== 'burek'); }
        if(player.weapons.burek.level>=8 && !player.weapons.burek.evolved) pool.unshift({id:'burek_evo',name:'TESLA ORBS',icon:'ðŸ’ ',desc:'EVOLUTION: Rotating explosive energy orbs. High Damage. 5s Cooldown.',legendary:true});
        let opts=(pool.length>3 && pool[0].id!=='burek_evo') ? pool.sort(()=>0.5-Math.random()).slice(0,3) : pool.slice(0,3);
        
        opts.forEach(o=>{
            const el=document.createElement('div'); el.className='card'; 
            if(o.legendary) el.classList.add('legendary');
            if(o.rare) el.classList.add('rare');
            el.innerHTML=`<div class="card-level">${['burek','cevapi','ajvar','rakija','pyramid','harmonika'].includes(o.id)?'Lvl '+(player.weapons[o.id].level+1):''}</div><div class="card-icon">${o.icon}</div><div class="card-name">${o.name}</div><div class="card-desc">${o.desc}</div>`;
            el.onclick=()=>{applyUpgrade(o.id);}; c.appendChild(el);
        });
    }

    function applyUpgrade(id){
        if(id==='burek'){player.weapons.burek.count++;player.weapons.burek.level++;player.weapons.burek.speed+=0.01;}
        if(id==='burek_evo'){player.weapons.burek.evolved=true;player.weapons.burek.speed=0.06;player.weapons.burek.dist=140;player.weapons.burek.count+=1;}
        
        if(id==='cevapi'){
            player.weapons.cevapi.level++;
            if(player.weapons.cevapi.level === 2) { player.weapons.cevapi.damage = 25; player.weapons.cevapi.baseCool *= 0.85; } else { player.weapons.cevapi.damage += 10; player.weapons.cevapi.baseCool *= 0.85; }
        }

        if(id==='ajvar'){if(player.weapons.ajvar.level===0)player.weapons.ajvar.level=1;else{player.weapons.ajvar.baseCool*=0.85;player.weapons.ajvar.damage+=20;}}
        if(id==='rakija'){if(player.weapons.rakija.level===0)player.weapons.rakija.level=1;else{player.weapons.rakija.baseCool*=0.85;player.weapons.rakija.damage+=2;}}
        if(id==='pyramid'){if(player.weapons.pyramid.level===0)player.weapons.pyramid.level=1;else{player.weapons.pyramid.baseCool*=0.85;player.weapons.pyramid.damage+=15;}}
        if(id==='harmonika'){if(player.weapons.harmonika.level===0)player.weapons.harmonika.level=1;else{player.weapons.harmonika.baseCool*=0.80;player.weapons.harmonika.range+=40;player.weapons.harmonika.damage+=20;}}
        
        if(id==='speed')player.speed*=1.15; if(id==='magnet')player.magnetRadius+=50; if(id==='armor')player.armor+=1.5; if(id==='heal')player.hp=Math.min(player.maxHp,player.hp+50);
        if(id==='coffee')player.cdr*=0.9; if(id==='lily')player.critChance+=0.10; if(id==='vrelo')player.regen+=2;
        if(id==='xp_boost') state.xpMult = 2;

        ['cevapi','ajvar','rakija','pyramid','harmonika'].forEach(w=>{ player.weapons[w].cooldown = player.weapons[w].baseCool * player.cdr; });

        document.getElementById('levelup-screen').style.display='none'; updateHud(); isPaused=false;
    }
    gameLoop();
</script>
</body>
</html>
